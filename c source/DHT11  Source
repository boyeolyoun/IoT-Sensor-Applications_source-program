#include <wiringPi.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#define Maxtiming 85
#define DhtPin 7

int dht11_dat[5] = {0,0,0,0,0};

void read_dht11_dat(){
    int laststate = HIGH;
    int counter = 0;
    int j = 0,i;
    float f;


    dht11_dat[0] = dht11_dat[1] = dht11_dat[2] = dht11_dat[3] = dht11_dat[4] = 0;

    pinMode(DhtPin,OUTPUT);
    digitalWrite(DhtPin,LOW);
    delay(18);
    digitalWrite(DhtPin,HIGH);
    delayMicroseconds(40);
    pinMode(DhtPin, INPUT);

    for(i = 0;i < Maxtiming; i++){
        counter = 0;

            while(digitalRead(DhtPin)==laststate){
                counter++;
                delayMicroseconds(1);

                if(counter == 255){
                    break;
                }
            }
            laststate = digitalRead(DhtPin);
            
            if(counter == 255) {break;}

                if((i>=4) && (i%2 == 0)){
                    dht11_dat[j/8] <<=1;
                    if(counter > 50) dht11_dat[j/8] |= 1;
                    j++;
                    
            }
    }

        if((j>=40) && (dht11_dat[4]) == (dht11_dat[0]+dht11_dat[1]+dht11_dat[2]+dht11_dat[3] & 0xFF)){
            f = dht11_dat[2]*9./5. + 32;
            printf("Humidity = %d.%d %% Temperature = %d.%d C(%.1f F)\n", dht11_dat[0],dht11_dat[1],dht11_dat[2],dht11_dat[3],f);

        }
        else{
            printf("Data not good, skip\n");
        }
        
    
}

int main(void){
    printf("Raspberry Pi wiringPi DHT11 Temperature test program\n");

    if(wiringPiSetup() == -1) exit(1);

    while(1){
        read_dht11_dat();
        delay(1000);

    }
    return 0;
}

